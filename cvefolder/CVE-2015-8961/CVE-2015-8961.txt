CVE Number : CVE-2015-8961
Commit Message : 
ext4: fix potential use after free in __ext4_journal_stop
Commit Details : 
There is a use-after-free possibility in __ext4_journal_stop() in the
case that we free the handle in the first jbd2_journal_stop() because
we're referencing handle->h_err afterwards. This was introduced in
9705acd63b125dee8b15c705216d7186daea4625 and it is wrong. Fix it by
storing the handle->h_err value beforehand and avoid referencing
potentially freed handle.

Fixes: 9705acd63b125dee8b15c705216d7186daea4625
Signed-off-by: Lukas Czerner <lczerner@redhat.com>
Reviewed-by: Andreas Dilger <adilger@dilger.ca>
Cc: stable@vger.kernel.org

Before patch : 
 		return 0;
 	}
 
 	if (!handle >h_transaction) {
 		err = jbd2_journal_stop(handle);
 		return handle >h_err ? handle >h_err : err;
 	}
 
 	sb = handle >h_transaction >t_journal >j_private;
 	err = handle >h_err;
 	rc = jbd2_journal_stop(handle);
 
 	if (!err)
After patch : 
 		return 0;
 	}
 
 	err = handle >h_err;
 	if (!handle >h_transaction) {
 		rc = jbd2_journal_stop(handle);
 		return err ? err : rc;
 	}
 
 	sb = handle >h_transaction >t_journal >j_private;
 	rc = jbd2_journal_stop(handle);
 
 	if (!err)
