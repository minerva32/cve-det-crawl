CVE Number : CVE-2011-0716
Commit Message : 
bridge: Fix mglist corruption that leads to memory corruption
Commit Details : 
The list mp->mglist is used to indicate whether a multicast group
is active on the bridge interface itself as opposed to one of the
constituent interfaces in the bridge.

Unfortunately the operation that adds the mp->mglist node to the
list neglected to check whether it has already been added.  This
leads to list corruption in the form of nodes pointing to itself.

Normally this would be quite obvious as it would cause an infinite
loop when walking the list.  However, as this list is never actually
walked (which means that we don't really need it, I'll get rid of
it in a subsequent patch), this instead is hidden until we perform
a delete operation on the affected nodes.

As the same node may now be pointed to by more than one node, the
delete operations can then cause modification of freed memory.

This was observed in practice to cause corruption in 512-byte slabs,
most commonly leading to crashes in jbd2.

Thanks to Josef Bacik for pointing me in the right direction.

Reported-by: Ian Page Hands <ihands@redhat.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: David S. Miller <davem@davemloft.net>

Before patch : 
 		goto err;
 
 	if (!port) {
 		hlist_add_head(&mp >mglist, &br >mglist);
 		mod_timer(&mp >timer, now   br >multicast_membership_interval);
 		goto out;
 	}
After patch : 
 		goto err;
 
 	if (!port) {
 		if (hlist_unhashed(&mp >mglist))
 			hlist_add_head(&mp >mglist, &br >mglist);
 		mod_timer(&mp >timer, now   br >multicast_membership_interval);
 		goto out;
 	}
