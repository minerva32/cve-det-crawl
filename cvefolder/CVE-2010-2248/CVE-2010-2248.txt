CVE Number : CVE-2010-2248
Commit Message : 
cifs: Fix a kernel BUG with remote OS/2 server (try #3)
Commit Details : 
While chasing a bug report involving a OS/2 server, I noticed the server sets
pSMBr->CountHigh to a incorrect value even in case of normal writes. This
results in 'nbytes' being computed wrongly and triggers a kernel BUG at
mm/filemap.c.

void iov_iter_advance(struct iov_iter *i, size_t bytes)
{
        BUG_ON(i->count < bytes);    <--- BUG here

Why the server is setting 'CountHigh' is not clear but only does so after
writing 64k bytes. Though this looks like the server bug, the client side
crash may not be acceptable.

The workaround is to mask off high 16 bits if the number of bytes written as
returned by the server is greater than the bytes requested by the client as
suggested by Jeff Layton.

CC: Stable <stable@kernel.org>
Reviewed-by: Jeff Layton <jlayton@samba.org>
Signed-off-by: Suresh Jayaraman <sjayaraman@suse.de>
Signed-off-by: Steve French <sfrench@us.ibm.com>

Before patch : 
 		*nbytes = le16_to_cpu(pSMBr >CountHigh);
 		*nbytes = (*nbytes) << 16;
 		*nbytes  = le16_to_cpu(pSMBr >Count);
 	}
 
 	cifs_buf_release(pSMB);
 		*nbytes = le16_to_cpu(pSMBr >CountHigh);
 		*nbytes = (*nbytes) << 16;
 		*nbytes  = le16_to_cpu(pSMBr >Count);
 	}
 
 /*	cifs_small_buf_release(pSMB); */ /* Freed earlier now in SendReceive2 */
After patch : 
 		*nbytes = le16_to_cpu(pSMBr >CountHigh);
 		*nbytes = (*nbytes) << 16;
 		*nbytes  = le16_to_cpu(pSMBr >Count);
 
 		/*
 		 * Mask off high 16 bits when bytes written as returned by the
 		 * server is greater than bytes requested by the client. Some
 		 * OS/2 servers are known to set incorrect CountHigh values.
 		 */
 		if (*nbytes > count)
 			*nbytes &= 0xFFFF;
 	}
 
 	cifs_buf_release(pSMB);
 		*nbytes = le16_to_cpu(pSMBr >CountHigh);
 		*nbytes = (*nbytes) << 16;
 		*nbytes  = le16_to_cpu(pSMBr >Count);
 
 		/*
 		 * Mask off high 16 bits when bytes written as returned by the
 		 * server is greater than bytes requested by the client. OS/2
 		 * servers are known to set incorrect CountHigh values.
 		 */
 		if (*nbytes > count)
 			*nbytes &= 0xFFFF;
 	}
 
 /*	cifs_small_buf_release(pSMB); */ /* Freed earlier now in SendReceive2 */
