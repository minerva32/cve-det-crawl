CVE Number : CVE-2014-3534
Commit Message : 
s390/ptrace: fix PSW mask check
Commit Details : 
The PSW mask check of the PTRACE_POKEUSR_AREA command is incorrect.
The PSW_MASK_USER define contains the PSW_MASK_ASC bits, the ptrace
interface accepts all combinations for the address-space-control
bits. To protect the kernel space the PSW mask check in ptrace needs
to reject the address-space-control bit combination for home space.

Fixes CVE-2014-3534

Cc: stable@vger.kernel.org
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>

Before patch : 
 			unsigned long mask = PSW_MASK_USER;
 
 			mask |= is_ri_task(child) ? PSW_MASK_RI : 0;
 			if ((data & ~mask) != PSW_USER_BITS)
 				return  EINVAL;
 			if ((data & PSW_MASK_EA) && !(data & PSW_MASK_BA))
 				return  EINVAL;
 		}
 		*(addr_t *)((addr_t) &task_pt_regs(child) >psw   addr) = data;
 
 			mask |= is_ri_task(child) ? PSW32_MASK_RI : 0;
 			/* Build a 64 bit psw mask from 31 bit mask. */
 			if ((tmp & ~mask) != PSW32_USER_BITS)
 				/* Invalid psw mask. */
 				return  EINVAL;
 			regs >psw.mask = (regs >psw.mask & ~PSW_MASK_USER) |
 				(regs >psw.mask & PSW_MASK_BA) |
 				(__u64)(tmp & mask) << 32;
After patch : 
 			unsigned long mask = PSW_MASK_USER;
 
 			mask |= is_ri_task(child) ? PSW_MASK_RI : 0;
 			if ((data ^ PSW_USER_BITS) & ~mask)
 				/* Invalid psw mask. */
 				return  EINVAL;
 			if ((data & PSW_MASK_ASC) == PSW_ASC_HOME)
 				/* Invalid address space control bits */
 				return  EINVAL;
 			if ((data & PSW_MASK_EA) && !(data & PSW_MASK_BA))
 				/* Invalid addressing mode bits */
 				return  EINVAL;
 		}
 		*(addr_t *)((addr_t) &task_pt_regs(child) >psw   addr) = data;
 
 			mask |= is_ri_task(child) ? PSW32_MASK_RI : 0;
 			/* Build a 64 bit psw mask from 31 bit mask. */
 			if ((tmp ^ PSW32_USER_BITS) & ~mask)
 				/* Invalid psw mask. */
 				return  EINVAL;
 			if ((data & PSW32_MASK_ASC) == PSW32_ASC_HOME)
 				/* Invalid address space control bits */
 				return  EINVAL;
 			regs >psw.mask = (regs >psw.mask & ~PSW_MASK_USER) |
 				(regs >psw.mask & PSW_MASK_BA) |
 				(__u64)(tmp & mask) << 32;
