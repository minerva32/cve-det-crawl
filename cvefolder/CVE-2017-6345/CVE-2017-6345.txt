CVE Number : CVE-2017-6345
Commit Message : 
net/llc: avoid BUG_ON() in skb_orphan()
Commit Details : 
It seems nobody used LLC since linux-3.12.

Fortunately fuzzers like syzkaller still know how to run this code,
otherwise it would be no fun.

Setting skb->sk without skb->destructor leads to all kinds of
bugs, we now prefer to be very strict about it.

Ideally here we would use skb_set_owner() but this helper does not exist yet,
only CAN seems to have a private helper for that.

Fixes: 376c7311bdb6 ("net: add a temporary sanity check in skb_orphan()")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Andrey Konovalov <andreyknvl@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>

Before patch : 
 		 * another trick required to cope with how the PROCOM state
 		 * machine works.  acme
 		 */
 		skb >sk = sk;
 	}
 	if (!sock_owned_by_user(sk))
 		llc_conn_rcv(sk, skb);
 
 	ev >type   = LLC_SAP_EV_TYPE_PDU;
 	ev >reason = 0;
 	skb >sk = sk;
 	llc_sap_state_process(sap, skb);
 }
 
After patch : 
 		 * another trick required to cope with how the PROCOM state
 		 * machine works.  acme
 		 */
 		skb_orphan(skb);
 		sock_hold(sk);
 		skb >sk = sk;
 		skb >destructor = sock_efree;
 	}
 	if (!sock_owned_by_user(sk))
 		llc_conn_rcv(sk, skb);
 
 	ev >type   = LLC_SAP_EV_TYPE_PDU;
 	ev >reason = 0;
 	skb_orphan(skb);
 	sock_hold(sk);
 	skb >sk = sk;
 	skb >destructor = sock_efree;
 	llc_sap_state_process(sap, skb);
 }
 
