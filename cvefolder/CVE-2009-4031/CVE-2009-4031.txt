CVE Number : CVE-2009-4031
Commit Message : 
KVM: x86 emulator: limit instructions to 15 bytes
Commit Details : 
While we are never normally passed an instruction that exceeds 15 bytes,
smp games can cause us to attempt to interpret one, which will cause
large latencies in non-preempt hosts.

Cc: stable@kernel.org
Signed-off-by: Avi Kivity <avi@redhat.com>

Before patch : 
 	u8 seg_override;
 	unsigned int d;
 	unsigned long regs[NR_VCPU_REGS];
 	unsigned long eip;
 	/* modrm */
 	u8 modrm;
 	u8 modrm_mod;
 {
 	int rc = 0;
 
 	eip  = ctxt >cs_base;
 	while (size  ) {
 		rc = do_fetch_insn_byte(ctxt, ops, eip  , dest  );
 	/* Shadow copy of register state. Committed on successful emulation. */
 
 	memset(c, 0, sizeof(struct decode_cache));
 	c >eip = kvm_rip_read(ctxt >vcpu);
 	ctxt >cs_base = seg_base(ctxt, VCPU_SREG_CS);
 	memcpy(c >regs, ctxt >vcpu >arch.regs, sizeof c >regs);
 
After patch : 
 	u8 seg_override;
 	unsigned int d;
 	unsigned long regs[NR_VCPU_REGS];
 	unsigned long eip, eip_orig;
 	/* modrm */
 	u8 modrm;
 	u8 modrm_mod;
 {
 	int rc = 0;
 
 	/* x86 instructions are limited to 15 bytes. */
 	if (eip   size   ctxt >decode.eip_orig > 15)
 		return X86EMUL_UNHANDLEABLE;
 	eip  = ctxt >cs_base;
 	while (size  ) {
 		rc = do_fetch_insn_byte(ctxt, ops, eip  , dest  );
 	/* Shadow copy of register state. Committed on successful emulation. */
 
 	memset(c, 0, sizeof(struct decode_cache));
 	c >eip = c >eip_orig = kvm_rip_read(ctxt >vcpu);
 	ctxt >cs_base = seg_base(ctxt, VCPU_SREG_CS);
 	memcpy(c >regs, ctxt >vcpu >arch.regs, sizeof c >regs);
 
