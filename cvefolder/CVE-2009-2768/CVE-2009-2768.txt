CVE Number : CVE-2009-2768
Commit Message : 
flat: fix uninitialized ptr with shared libs
Commit Details : 
The new credentials code broke load_flat_shared_library() as it now uses
an uninitialized cred pointer.

Reported-by: Bernd Schmidt <bernds_cb1@t-online.de>
Tested-by: Bernd Schmidt <bernds_cb1@t-online.de>
Cc: Mike Frysinger <vapier@gentoo.org>
Cc: David Howells <dhowells@redhat.com>
Cc: <stable@kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

Before patch : 
 	if (IS_ERR(bprm.file))
 		return res;
 
 	res = prepare_binprm(&bprm);
 
 	if (res <= (unsigned long) 4096)
 		res = load_flat_file(&bprm, libs, id, NULL);
 	if (bprm.file) {
 		allow_write_access(bprm.file);
 		fput(bprm.file);
 		bprm.file = NULL;
 	}
 	return(res);
 }
 
After patch : 
 	if (IS_ERR(bprm.file))
 		return res;
 
 	bprm.cred = prepare_exec_creds();
 	res =  ENOMEM;
 	if (!bprm.cred)
 		goto out;
 
 	res = prepare_binprm(&bprm);
 
 	if (res <= (unsigned long) 4096)
 		res = load_flat_file(&bprm, libs, id, NULL);
 
 	abort_creds(bprm.cred);
 
 out:
 	allow_write_access(bprm.file);
 	fput(bprm.file);
 
 	return(res);
 }
 
