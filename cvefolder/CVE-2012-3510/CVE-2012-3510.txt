CVE Number : CVE-2012-3510
Commit Message : 
PATCH xacct_add_tsk: fix pure theoretical ->mm use-after-free
Commit Details : 
Paranoid fix. The task can free its ->mm after the 'if (p->mm)' check.

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Cc: Shailabh Nagar <nagar@watson.ibm.com>
Cc: Balbir Singh <balbir@in.ibm.com>
Cc: Jay Lan <jlan@sgi.com>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Before patch : 
  */
 void xacct_add_tsk(struct taskstats *stats, struct task_struct *p)
 {
 	/* convert pages jiffies to Mbyte usec */
 	stats >coremem = jiffies_to_usecs(p >acct_rss_mem1) * PAGE_SIZE / MB;
 	stats >virtmem = jiffies_to_usecs(p >acct_vm_mem1) * PAGE_SIZE / MB;
 	if (p >mm) {
 		/* adjust to KB unit */
 		stats >hiwater_rss   = p >mm >hiwater_rss * PAGE_SIZE / KB;
 		stats >hiwater_vm    = p >mm >hiwater_vm * PAGE_SIZE / KB;
 	}
 	stats >read_char	= p >rchar;
 	stats >write_char	= p >wchar;
After patch : 
  */
 void xacct_add_tsk(struct taskstats *stats, struct task_struct *p)
 {
 	struct mm_struct *mm;
 
 	/* convert pages jiffies to Mbyte usec */
 	stats >coremem = jiffies_to_usecs(p >acct_rss_mem1) * PAGE_SIZE / MB;
 	stats >virtmem = jiffies_to_usecs(p >acct_vm_mem1) * PAGE_SIZE / MB;
 	mm = get_task_mm(p);
 	if (mm) {
 		/* adjust to KB unit */
 		stats >hiwater_rss   = mm >hiwater_rss * PAGE_SIZE / KB;
 		stats >hiwater_vm    = mm >hiwater_vm * PAGE_SIZE / KB;
 		mmput(mm);
 	}
 	stats >read_char	= p >rchar;
 	stats >write_char	= p >wchar;
