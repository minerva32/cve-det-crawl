CVE Number : CVE-2016-6156
Commit Message : 
platform/chrome: cros_ec_dev - double fetch bug in ioctl
Commit Details : 
We verify "u_cmd.outsize" and "u_cmd.insize" but we need to make sure
that those values have not changed between the two copy_from_user()
calls.  Otherwise it could lead to a buffer overflow.

Additionally, cros_ec_cmd_xfer() can set s_cmd->insize to a lower value.
We should use the new smaller value so we don't copy too much data to
the user.

Reported-by: Pengfei Wang <wpengfeinudt@gmail.com>
Fixes: a841178445bb ('mfd: cros_ec: Use a zero-length array for command data')
Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
Reviewed-by: Kees Cook <keescook@chromium.org>
Tested-by: Gwendal Grignou <gwendal@chromium.org>
Cc: <stable@vger.kernel.org> # v4.2+
Signed-off-by: Olof Johansson <olof@lixom.net>

Before patch : 
 		goto exit;
 	}
 
 	s_cmd >command  = ec >cmd_offset;
 	ret = cros_ec_cmd_xfer(ec >ec_dev, s_cmd);
 	/* Only copy data to userland if data was received. */
 	if (ret < 0)
 		goto exit;
 
 	if (copy_to_user(arg, s_cmd, sizeof(*s_cmd)   u_cmd.insize))
 		ret =  EFAULT;
 exit:
 	kfree(s_cmd);
After patch : 
 		goto exit;
 	}
 
 	if (u_cmd.outsize != s_cmd >outsize ||
 	    u_cmd.insize != s_cmd >insize) {
 		ret =  EINVAL;
 		goto exit;
 	}
 
 	s_cmd >command  = ec >cmd_offset;
 	ret = cros_ec_cmd_xfer(ec >ec_dev, s_cmd);
 	/* Only copy data to userland if data was received. */
 	if (ret < 0)
 		goto exit;
 
 	if (copy_to_user(arg, s_cmd, sizeof(*s_cmd)   s_cmd >insize))
 		ret =  EFAULT;
 exit:
 	kfree(s_cmd);
